# 프로젝트 관련 JWT 사용전략

**사용자가 로그인 하면 토큰은 액세스 토큰, 리프레시 토큰을 생산한다. 그리고 사용자에게 전달. Res header에 넣어서 전달.**

리프레시 토큰은 expiration기간을 길게 설정하고서 DB에도 저장해놓음.

사용자가 api를 요청할 때 refresh토큰을 체크하여 access token을 재 발급 필요시 재발급하여 사용자에게 다시 전달하여 만료기간을 연장.

DTO = Data Transfer Object (데이터 전송 객체)

프로세스 간에 데이터를 전달하는 객체 

Access Token : 사용자 정보를 claim에 추가함.

Refresh Token: 사용자 정보에 대한 claim은 추가하지 않고, Token의 만료기간만 7일인 10,080분으로 설정

Claim이라는 사용자에 대한 프로퍼티나 속성을 이야기 합니다. 토큰 자체가 정보를 가지고 있는 방식인데, JWT는 이 Claim을 JSON을 이용해서 정의

**다음은 Claim을 JSON으로 서술한 예입니다. 이 JSON 자체를 토큰으로 사용하는 것이 Claim 기반의 토큰 방식입니다.**

{

    "id":"terry"

    ,"role":["admin","user"]

    ,"company":"pepsi"

}

즉 회원가입은 별도의 서비스로 빼버리고, 

해당 서비스에서 회원가입 요청을 보내게 되면 만들어질때 토큰을 만들고나서 DB에 리프레시를 같이 넣은 정보를 보내주고 클라이언트에게는 액세스토큰, 리프레시 토큰을 보내준다.

이후에 user에게서 받는 토큰을 확인하여 로그인 인증을 하게 되고 이후에 api 요청들을 권한에 맞게 승인해준다.

JWT는 Claim를 JSON형태로 표현하는 것인데, JSON은 "\n"등 개행문자가 있기 때문에, REST API 호출시 HTTP Header등에 넣기가 매우 불편합니다. 그래서, JWT에서는 이 Claim JSON 문자열을 BASE64 인코딩을 통해서 하나의 문자열로 변환합니다.

**JWT의 문제점**

사용이 쉽고, 서버의 개발 부담을 덜어줄 수 있다는 여러가지 장점을 가지고 있으나, 그만큼 또 단점도 가지고 있습니다.

**1. 길이**

Claim에 넣는 데이터가 많아질수록, JWT 토큰의 길이가 길어집니다. API 호출등에 사용할 시에, 매 호출마다 헤더에 붙어서 가야하기 때문에, 길이가 길다는 것은 그만큼 네트워크 대역폭 낭비가 심하다는 의미입니다.

**2. 한번 발급된 토큰은 값을 수정하거나 폐기가 불가**

JWT는 토큰 내에 모든 정보를 다 가지고 있기 때문에, 한번 발급된 토큰에 대한 변경은 서버에서는 더이상 불가능합니다. 예를 들어 토큰을 잘못 발행해서 삭제하고 싶더라도, Sinagture만 맞으면 맞는 토큰으로 인식을 하기 때문에, 서버에는 한번 발급된 토큰의 정보를 바꾸는 일등이 불가능합니다.

그래서 만약에 JWT를 쓴다면, Expire time을 꼭 명시적으로 두도록하고, refresh token등을 이용해서, 중간중간 토큰을 재발행하도록 해야합니다.

**3. 보안**

JWT는 기본적으로 Claim에 대한 정보를 암호화하지 않는다. 단순히 BASE64로 인코딩만 하기 때문에, 중간에 패킷을 가로채거나, 기타 방법으로 토큰을 취득했으면 토큰 내부 정보를 통해서 사용자 정보가 누출 될 수 있는 가능성이 있습니다. 특히 자바스크립트 기반의 웹 클라이언트의 경우 브라우저상의 디버거등을 통해서 토큰이 노출될 가능성이 높습니다. 그래서, 이를 보완하는 방법으로는 토큰 자체를 암호화하는 방법이 잇습니다. JSON을 암호화하기 위한 스펙으로는 JWE(JSON Web Encryption)이 있습니다.

그렇다면,

<mark>Access 토큰에 집어넣을 클레임은 무엇을 하는가?</mark>

<mark>권한레벨?</mark>

<mark>uid정도?</mark> 

기기정보?

기기 mac주소?



즉, 유저라우터는 유저가 토큰을 정상적으로 가지고 있을 경우에만 가능하도록하고

login라우터라고 해야하나? 

토큰 최초 발급을 위한 로그인은 login 라우트에서 발행?

회원가입도 login 라우트에서

위 해당 기기를 보고서 토큰이 없으면 토큰을 발행 --> 리프레시에 토큰 저장.



토큰이 없는데 로그인을 하는 경우? - 첫 로그인일경우, 분실하고서 로그인을 시도하는 경우

토큰은 있는데 만료가 된 경우?

액세스 토큰은 있지만 리프레시 토큰이 없는 경우?

액세스 토큰은 없지만 리프레시 토큰은 있는 경우? -> 리프레시 토큰을 비교해서 같다면 새로 엑세스 토큰 전달




